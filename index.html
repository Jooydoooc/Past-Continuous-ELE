<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Past Continuous Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 24px;
            font-size: 2rem;
            font-weight: 700;
        }

        .card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
        }

        .instructions {
            background: #ebf8ff;
            border-left: 4px solid #3182ce;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .name-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 20px 0;
        }

        @media (max-width: 640px) {
            .name-inputs {
                grid-template-columns: 1fr;
            }
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 6px;
            font-size: 14px;
        }

        input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
        }

        input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        button:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }

        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .test-section {
            display: none;
        }

        .student-header {
            background: #2d3748;
            color: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .question {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .question-text {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 12px;
            color: #2d3748;
        }

        .answer-input {
            width: 70px;
            padding: 6px 8px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            margin: 0 2px;
        }

        .answer-input:focus {
            border-color: #4299e1;
            outline: none;
        }

        .feedback {
            margin-top: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .correct {
            color: #38a169;
        }

        .incorrect {
            color: #e53e3e;
        }

        .input-correct {
            border-color: #38a169;
            background: #f0fff4;
        }

        .input-incorrect {
            border-color: #e53e3e;
            background: #fff5f5;
        }

        .results {
            background: white;
            border: 2px solid;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin: 24px 0;
            display: none;
        }

        .results.good {
            border-color: #38a169;
            background: #f0fff4;
        }

        .results.average {
            border-color: #d69e2e;
            background: #fffaf0;
        }

        .results.poor {
            border-color: #e53e3e;
            background: #fff5f5;
        }

        .telegram-status {
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin: 16px 0;
            display: none;
            font-size: 14px;
        }

        .telegram-success {
            background: #f0fff4;
            border: 1px solid #38a169;
            color: #276749;
        }

        .telegram-error {
            background: #fff5f5;
            border: 1px solid #e53e3e;
            color: #c53030;
        }

        .warning-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .warning-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            margin: 20px;
        }

        .security-alert {
            background: #fffaf0;
            border: 1px solid #d69e2e;
            color: #744210;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            text-align: center;
            font-size: 14px;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="warning-modal" id="warningModal">
        <div class="warning-content">
            <h3 style="color: #e53e3e; margin-bottom: 16px;">⚠️ Test Interrupted</h3>
            <p style="margin-bottom: 20px; line-height: 1.5;">
                You switched away from the test. For security, the test will restart.
            </p>
            <button onclick="restartTest()" style="background: #e53e3e;">Restart Test</button>
        </div>
    </div>

    <div class="container">
        <h1>Past Continuous Test</h1>

        <!-- Name Entry -->
        <div id="nameGate">
            <div class="card">
                <div class="instructions">
                    <p><strong>Welcome!</strong> Enter your name to begin the test.</p>
                </div>
                
                <div class="name-inputs">
                    <div class="input-group">
                        <label for="firstName">First Name</label>
                        <input type="text" id="firstName" placeholder="Your first name">
                    </div>
                    <div class="input-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" id="lastName" placeholder="Your last name">
                    </div>
                </div>

                <button onclick="startTest()">Start Test</button>
                
                <p style="text-align: center; color: #718096; margin-top: 16px; font-size: 14px;">
                    Results will be sent to your teacher automatically
                </p>
            </div>
        </div>

        <!-- Test Section -->
        <div id="testSection" class="test-section">
            <div class="student-header" id="studentInfo"></div>
            
            <div class="security-alert">
                ⚠️ Do not switch tabs or apps during the test
            </div>

            <div class="instructions">
                <p><strong>Instructions:</strong> Write the verb form in each blank.</p>
                <p>• Use contractions (wasn't, weren't) if needed<br>
                   • Case and spaces don't matter</p>
            </div>

            <form id="testForm"></form>

            <button onclick="checkAnswers()" id="submitButton">Submit Answers</button>
            
            <div id="results" class="results"></div>
            <div id="telegramStatus" class="telegram-status"></div>
        </div>
    </div>

    <script>
        // State management
        let studentName = '';
        let totalBlanks = 0;
        let testStarted = false;

        // Answer key
        const answerKey = {
            q1: { blanks: 2, correctAnswers: [["were eating"], ["went"]] },
            q2: { blanks: 1, correctAnswers: [["were playing"]] },
            q3: { blanks: 2, correctAnswers: [["was"], ["driving"]] },
            q4: { blanks: 2, correctAnswers: [["were walking"], ["saw"]] },
            q5: { blanks: 1, correctAnswers: [["was not watching", "wasn't watching", "wasn't watching"]] },
            q6: { blanks: 2, correctAnswers: [["were doing"], ["entered"]] },
            q7: { blanks: 1, correctAnswers: [["were driving"]] },
            q8: { blanks: 2, correctAnswers: [["was cooking"], ["was setting"]] },
            q9: { blanks: 2, correctAnswers: [["were"], ["doing"]] },
            q10: { blanks: 2, correctAnswers: [["was watching"], ["came"]] },
            q11: { blanks: 1, correctAnswers: [["were studying"]] },
            q12: { blanks: 1, correctAnswers: [["were not talking", "weren't talking", "weren't talking"]] },
            q13: { blanks: 2, correctAnswers: [["were waiting"], ["was raining"]] },
            q14: { blanks: 1, correctAnswers: [["was cooking"]] },
            q15: { blanks: 2, correctAnswers: [["was explaining"], ["were taking"]] },
            q16: { blanks: 2, correctAnswers: [["were"], ["working"]] },
            q17: { blanks: 1, correctAnswers: [["was talking"]] },
            q18: { blanks: 1, correctAnswers: [["were not listening", "weren't listening", "weren't listening"]] },
            q19: { blanks: 2, correctAnswers: [["was having"], ["rang"]] },
            q20: { blanks: 1, correctAnswers: [["were not waiting", "weren't waiting", "weren't waiting"]] },
            q21: { blanks: 2, correctAnswers: [["were studying"], ["were using"]] },
            q22: { blanks: 1, correctAnswers: [["was not sleeping", "wasn't sleeping", "wasn't sleeping"]] },
            q23: { blanks: 2, correctAnswers: [["were"], ["sitting"]] },
            q24: { blanks: 2, correctAnswers: [["was walking"], ["was talking"]] },
            q25: { blanks: 2, correctAnswers: [["was"], ["crying"]] }
        };

        // Questions
        const questions = [
            "While we ________ (eat) dinner, the lights ________ (go) off.",
            "They ________ (play) football in the yard at 5 o'clock.",
            "________ he ________ (drive) to work at 8 yesterday morning?",
            "While they ________ (walk) to school, they ________ (see) a car accident.",
            "I ________ (not / watch) TV at 10 p.m. yesterday.",
            "While the students ________ (do) the test, the headmaster ________ (enter) the classroom.",
            "My parents ________ (drive) to Tashkent late last night.",
            "While my brother ________ (cook) dinner, my sister ________ (set) the table.",
            "What ________ you ________ (do) at 9 p.m. last night?",
            "While I ________ (watch) TV, my mother ________ (come) home.",
            "We ________ (study) English in the classroom at 3 p.m. yesterday.",
            "The students ________ (not / talk) loudly in the library.",
            "While we ________ (wait) for the bus, it ________ (rain) heavily.",
            "I ________ (cook) dinner at 7 p.m. yesterday.",
            "While the teacher ________ (explain) the rules, the students ________ (take) notes.",
            "________ your parents ________ (work) at the factory in 2010?",
            "She ________ (talk) on the phone at 9 last night.",
            "They ________ (not / listen) to the teacher during the test.",
            "While he ________ (have) a shower, the phone ________ (ring).",
            "We ________ (not / wait) for the bus in the rain.",
            "While they ________ (study) in the library, other students ________ (use) the computers.",
            "He ________ (not / sleep) when his friend called.",
            "Where ________ they ________ (sit) in the classroom during the test?",
            "While I ________ (walk) home, my friend ________ (talk) to me on the phone.",
            "Why ________ she ________ (cry) in the street yesterday?"
        ];

        // Security features
        document.addEventListener('visibilitychange', function() {
            if (testStarted && document.visibilityState === 'hidden') {
                setTimeout(() => {
                    if (document.visibilityState === 'hidden') {
                        showWarning();
                    }
                }, 1000);
            }
        });

        document.addEventListener('contextmenu', function(e) {
            if (testStarted) e.preventDefault();
        });

        function showWarning() {
            document.getElementById('warningModal').style.display = 'flex';
        }

        function restartTest() {
            location.reload();
        }

        // Test functions
        function startTest() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            
            if (!firstName || !lastName) {
                alert('Please enter both name and surname');
                return;
            }
            
            studentName = `${firstName} ${lastName}`;
            testStarted = true;
            
            document.getElementById('nameGate').style.display = 'none';
            document.getElementById('testSection').style.display = 'block';
            document.getElementById('studentInfo').textContent = `Student: ${studentName}`;
            
            initializeTest();
        }

        function initializeTest() {
            const form = document.getElementById('testForm');
            form.innerHTML = '';
            totalBlanks = 0;
            
            questions.forEach((question, index) => {
                const questionNum = index + 1;
                const questionKey = `q${questionNum}`;
                const blanksCount = answerKey[questionKey].blanks;
                totalBlanks += blanksCount;
                
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = `
                    <div class="question-text">${formatQuestion(question, questionNum, blanksCount)}</div>
                    <div class="feedback" id="feedback-${questionNum}"></div>
                `;
                form.appendChild(questionDiv);
            });
        }

        function formatQuestion(question, questionNum, blanksCount) {
            let formatted = `Q${questionNum}. `;
            let blankIndex = 0;
            
            const parts = question.split('________');
            parts.forEach((part, index) => {
                formatted += part;
                if (index < parts.length - 1) {
                    formatted += `<input type="text" class="answer-input" id="q${questionNum}_${blankIndex}">`;
                    blankIndex++;
                }
            });
            
            return formatted;
        }

        function normalizeAnswer(str) {
            return str.trim().replace(/\s+/g, ' ').toLowerCase();
        }

        function isAnswerCorrect(userAnswer, correctOptions) {
            if (!userAnswer) return false;
            const normalized = normalizeAnswer(userAnswer);
            return correctOptions.some(option => normalized === normalizeAnswer(option));
        }

        async function checkAnswers() {
            const button = document.getElementById('submitButton');
            button.disabled = true;
            button.textContent = 'Checking...';
            document.body.classList.add('loading');

            let score = 0;
            const blankResults = [];

            // Check answers
            for (let questionNum = 1; questionNum <= 25; questionNum++) {
                const questionKey = `q${questionNum}`;
                const blanksCount = answerKey[questionKey].blanks;
                let questionCorrect = true;
                
                for (let blankIndex = 0; blankIndex < blanksCount; blankIndex++) {
                    const input = document.getElementById(`${questionKey}_${blankIndex}`);
                    const userAnswer = input.value;
                    const correctOptions = answerKey[questionKey].correctAnswers[blankIndex];
                    
                    const isCorrect = isAnswerCorrect(userAnswer, correctOptions);
                    
                    input.classList.remove('input-correct', 'input-incorrect');
                    if (isCorrect) {
                        input.classList.add('input-correct');
                        score++;
                    } else {
                        input.classList.add('input-incorrect');
                        questionCorrect = false;
                    }
                    
                    blankResults.push({
                        questionLabel: `Q${questionNum} (blank ${blankIndex + 1})`,
                        userAnswer: userAnswer || '(empty)',
                        correct: isCorrect,
                        correctAnswers: correctOptions
                    });
                }
                
                const feedback = document.getElementById(`feedback-${questionNum}`);
                if (questionCorrect) {
                    feedback.textContent = '✅ Correct';
                    feedback.className = 'feedback correct';
                } else {
                    feedback.textContent = '❌ Try again';
                    feedback.className = 'feedback incorrect';
                }
            }

            // Show results
            showResults(score);
            
            // Send to Telegram
            sendToTelegram(blankResults, score);
            
            button.disabled = false;
            button.textContent = 'Submit Answers';
            document.body.classList.remove('loading');
        }

        function showResults(score) {
            const resultsDiv = document.getElementById('results');
            const percentage = (score / totalBlanks) * 100;
            
            let resultClass = 'average';
            if (percentage >= 80) resultClass = 'good';
            if (percentage < 60) resultClass = 'poor';
            
            resultsDiv.innerHTML = `
                <h3>Test Completed!</h3>
                <p>Score: <strong>${score}/${totalBlanks}</strong></p>
                <p>Percentage: <strong>${percentage.toFixed(1)}%</strong></p>
            `;
            resultsDiv.className = `results ${resultClass}`;
            resultsDiv.style.display = 'block';
        }

        async function sendToTelegram(blankResults, score) {
            const statusDiv = document.getElementById('telegramStatus');
            
            try {
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        studentName,
                        answers: blankResults,
                        score,
                        total: totalBlanks
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    statusDiv.textContent = '✅ Results sent to teacher';
                    statusDiv.className = 'telegram-status telegram-success';
                } else {
                    statusDiv.textContent = `❌ Results saved (Telegram: ${result.error})`;
                    statusDiv.className = 'telegram-status telegram-error';
                }
            } catch (error) {
                statusDiv.textContent = '❌ Results saved (Network error)';
                statusDiv.className = 'telegram-status telegram-error';
            }
            
            statusDiv.style.display = 'block';
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const firstName = document.getElementById('firstName');
            const lastName = document.getElementById('lastName');
            
            function handleEnter(event) {
                if (event.key === 'Enter') startTest();
            }
            
            firstName.addEventListener('keypress', handleEnter);
            lastName.addEventListener('keypress', handleEnter);
            
            firstName.focus();
        });
    </script>
</body>
</html>
